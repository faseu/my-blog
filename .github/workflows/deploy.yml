name: Deploy to VPS

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„ push äº‹ä»¶

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ æ‹‰å– Git ä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ”‘ é…ç½® SSH å…å¯†ç™»å½•
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 64.176.56.4 >> ~/.ssh/known_hosts

    - name: ğŸš€ è¿œç¨‹éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        ssh -o StrictHostKeyChecking=no root@64.176.56.4 << 'EOF'
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p /var/www/my-blog
          cd /var/www/my-blog

          # å¦‚æœæ²¡æœ‰ .git ç›®å½•ï¼Œåˆ™å…‹éš†ä»“åº“ï¼Œå¦åˆ™æ‹‰å–æœ€æ–°ä»£ç 
          if [ ! -d ".git" ]; then
            git clone git@github.com:faseu/my-blog.git .
          else
            git reset --hard
            git pull origin main
          fi

          # ç¡®ä¿ Node.js å’Œ Yarn å¯ç”¨
          if ! command -v yarn &> /dev/null; then
            echo "âš ï¸ yarn æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£… Node.js å’Œ Yarn..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt install -y nodejs
            # å®‰è£… Yarn
            curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
            echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
            sudo apt update && sudo apt install yarn
          fi

          # å®‰è£…ä¾èµ–å¹¶æ„å»º
          yarn install
          yarn build

          # é‡å¯ Nginx
          sudo systemctl restart nginx
        EOF
